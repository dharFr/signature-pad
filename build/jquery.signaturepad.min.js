/*
 SignaturePad: A jQuery plugin for assisting in the creation of an HTML5 canvas
 based signature pad. Records the drawn signature in JSON for later regeneration.

 Dependencies: FlashCanvas/1.5, json2.js, jQuery/1.3.2+

 @project ca.thomasjbradley.applications.signaturepad
 @author Thomas J Bradley <hey@thomasjbradley.ca>
 @link http://thomasjbradley.ca/lab/signature-pad
 @link http://github.com/thomasjbradley/signature-pad
 @copyright Copyright MMXI, Thomas J Bradley
 @license New BSD License
 @version 2.2.0
*/
(function(b){function u(r,p){var k,l;function s(d,c){var f=b(d.target).offset(),j;clearTimeout(n);n=!1;"undefined"!==typeof d.changedTouches?(j=Math.floor(d.changedTouches[0].pageX-f.left),f=Math.floor(d.changedTouches[0].pageY-f.top)):(j=Math.floor(d.pageX-f.left),f=Math.floor(d.pageY-f.top));if(k===j&&l===f)return!0;null===k&&(k=j);null===l&&(l=f);c&&(f+=c);e.beginPath();e.moveTo(k,l);e.lineTo(j,f);e.lineCap=a.penCap;e.stroke();e.closePath();i.push({lx:j,ly:f,mx:k,my:l});k=j;l=f}function m(){q?
g.each(function(){this.ontouchmove=null}):g.unbind("mousemove.signaturepad");l=k=null;0<i.length&&(b(a.output,c).val(JSON.stringify(i)),v())}function t(){m();e.clearRect(0,0,h.width,h.height);e.fillStyle=a.bgColour;e.fillRect(0,0,h.width,h.height);a.displayOnly||a.lineWidth&&(e.beginPath(),e.lineWidth=a.lineWidth,e.strokeStyle=a.lineColour,e.moveTo(a.lineMargin,a.lineTop),e.lineTo(h.width-a.lineMargin,a.lineTop),e.stroke(),e.closePath());e.lineWidth=a.penWidth;e.strokeStyle=a.penColour;b(a.output,
c).val("");i=[];v()}function y(d){q?g.each(function(){this.addEventListener("touchmove",s,!1)}):g.bind("mousemove.signaturepad",s);s(d,1)}function u(){w=!1;q?g.each(function(){this.removeEventListener("touchstart",m);this.removeEventListener("touchend",m);this.removeEventListener("touchmove",s)}):(g.unbind("mousedown.signaturepad"),g.unbind("mouseup.signaturepad"),g.unbind("mousemove.signaturepad"),g.unbind("mouseleave.signaturepad"));b(a.clear,c).unbind("click.signaturepad")}function z(d){if(w)return!1;
w=!0;"undefined"!==typeof d.changedTouches&&(q=!0);q?(g.each(function(){this.addEventListener("touchend",m,!1);this.addEventListener("touchcancel",m,!1)}),g.unbind("mousedown.signaturepad")):(g.bind("mouseup.signaturepad",function(){m()}),g.bind("mouseleave.signaturepad",function(){n||(n=setTimeout(function(){m();clearTimeout(n);n=!1},500))}),g.each(function(){this.ontouchstart=null}))}function x(){b(a.typed,c).hide();t();g.each(function(){this.ontouchstart=function(d){d.preventDefault();z(d);y(d,
this)}});g.bind("mousedown.signaturepad",function(d){z(d);y(d,this)});b(a.clear,c).bind("click.signaturepad",function(d){d.preventDefault();t()});b(a.typeIt,c).bind("click.signaturepad",function(d){d.preventDefault();A()});b(a.drawIt,c).unbind("click.signaturepad");b(a.drawIt,c).bind("click.signaturepad",function(d){d.preventDefault()});b(a.typeIt,c).removeClass(a.currentClass);b(a.drawIt,c).addClass(a.currentClass);b(a.sig,c).addClass(a.currentClass);b(a.typeItDesc,c).hide();b(a.drawItDesc,c).show();
b(a.clear,c).show()}function A(){t();u();b(a.typed,c).show();b(a.drawIt,c).bind("click.signaturepad",function(d){d.preventDefault();x()});b(a.typeIt,c).unbind("click.signaturepad");b(a.typeIt,c).bind("click.signaturepad",function(d){d.preventDefault()});b(a.output,c).val("");b(a.drawIt,c).removeClass(a.currentClass);b(a.typeIt,c).addClass(a.currentClass);b(a.sig,c).removeClass(a.currentClass);b(a.drawItDesc,c).hide();b(a.clear,c).hide();b(a.typeItDesc,c).show()}function B(d){for(b(a.typed,c).html(d.replace(/>/g,
"&gt;").replace(/</g,"&lt;"));b(a.typed,c).width()>h.width;)d=b(a.typed,c).css("font-size").replace(/px/,""),b(a.typed,c).css("font-size",d-1+"px")}function E(d,a){b("p."+a.errorClass,d).remove();d.removeClass(a.errorClass);b("input, label",d).removeClass(a.errorClass)}function F(a,c,f){a.nameInvalid&&(c.prepend(['<p class="',f.errorClass,'">',f.errorMessage,"</p>"].join("")),b(f.name,c).focus(),b(f.name,c).addClass(f.errorClass),b("label[for="+b(f.name).attr("id")+"]",c).addClass(f.errorClass));
a.drawInvalid&&c.prepend(['<p class="',f.errorClass,'">',f.errorMessageDraw,"</p>"].join(""))}function v(){if(a.onOutputChange&&"function"===typeof a.onOutputChange)a.onOutputChange(i)}function C(){var d=!0,e={drawInvalid:!1,nameInvalid:!1},f=[c,a],j=[e,c,a];a.onBeforeValidate&&"function"===typeof a.onBeforeValidate?a.onBeforeValidate.apply(o,f):E.apply(o,f);a.drawOnly&&1>i.length&&(e.drawInvalid=!0,d=!1);""===b(a.name,c).val()&&(e.nameInvalid=!0,d=!1);a.onFormError&&"function"===typeof a.onFormError?
a.onFormError.apply(o,j):F.apply(o,j);return d}function D(d,b,c){for(var e in d)"object"===typeof d[e]&&(b.beginPath(),b.moveTo(d[e].mx,d[e].my),b.lineTo(d[e].lx,d[e].ly),b.lineCap=a.penCap,b.stroke(),b.closePath(),c&&i.push({lx:d[e].lx,ly:d[e].ly,mx:d[e].mx,my:d[e].my}))}function G(){if(4.1>parseFloat((/CPU.+OS ([0-9_]{3}).*AppleWebkit.*Mobile/i.exec(navigator.userAgent)||[0,"4_2"])[1].replace("_",".")))b.fn.Oldoffset=b.fn.offset,b.fn.offset=function(){var a=b(this).Oldoffset();a.top-=window.scrollY;
a.left-=window.scrollX;return a};b(a.typed,c).bind("selectstart.signaturepad",function(a){return b(a.target).is(":input")});g.bind("selectstart.signaturepad",function(a){return b(a.target).is(":input")});!h.getContext&&FlashCanvas&&FlashCanvas.initElement(h);h.getContext&&(e=h.getContext("2d"),b(a.sig,c).show(),a.displayOnly||(a.drawOnly||(b(a.name,c).bind("keyup.signaturepad",function(){B(b(this).val())}),b(a.name,c).bind("blur.signaturepad",function(){B(b(this).val())}),b(a.drawIt,c).bind("click.signaturepad",
function(a){a.preventDefault();x()})),a.drawOnly||"drawIt"===a.defaultAction?x():A(),a.validateFields&&(b(r).is("form")?b(r).bind("submit.signaturepad",function(){return C()}):b(r).parents("form").bind("submit.signaturepad",function(){return C()})),b(a.sigNav,c).show()))}var o=this,a=b.extend({},b.fn.signaturePad.defaults,p),c=b(r),g=b(a.canvas,c),h=g.get(0),e=null;l=k=null;var i=[],n=!1,q=!1,w=!1;b.extend(o,{init:function(){G()},regenerate:function(d){o.clearCanvas();b(a.typed,c).hide();"string"===
typeof d&&(d=JSON.parse(d));D(d,e,!0);0<b(a.output,c).length&&(b(a.output,c).val(JSON.stringify(i)),v())},clearCanvas:function(){t()},getSignature:function(){return i},getSignatureString:function(){return JSON.stringify(i)},getSignatureImage:function(){var b=document.createElement("canvas"),c=null,c=null;b.style.position="absolute";b.style.top="-999em";b.width=h.width;b.height=h.height;document.body.appendChild(b);!b.getContext&&FlashCanvas&&FlashCanvas.initElement(b);c=b.getContext("2d");c.fillStyle=
a.bgColour;c.fillRect(0,0,h.width,h.height);c.lineWidth=a.penWidth;c.strokeStyle=a.penColour;D(i,c);c=b.toDataURL.apply(b,arguments);document.body.removeChild(b);return c}})}b.fn.signaturePad=function(b){var p=null;this.each(function(){p=new u(this,b);p.init()});return p};b.fn.signaturePad.defaults={defaultAction:"typeIt",displayOnly:!1,drawOnly:!1,canvas:"canvas",sig:".sig",sigNav:".sigNav",bgColour:"#ffffff",penColour:"#145394",penWidth:2,penCap:"round",lineColour:"#ccc",lineWidth:2,lineMargin:5,
lineTop:35,name:".name",typed:".typed",clear:".clearButton",typeIt:".typeIt a",drawIt:".drawIt a",typeItDesc:".typeItDesc",drawItDesc:".drawItDesc",output:".output",currentClass:"current",validateFields:!0,errorClass:"error",errorMessage:"Please enter your name",errorMessageDraw:"Please sign the document",onBeforeValidate:null,onFormError:null,onOutputChange:null}})(jQuery);
